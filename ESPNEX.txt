#include "rwmake.ch"
#INCLUDE "topconn.ch"
#INCLUDE "totvs.ch"

User Function ESPNEX(comprador)
Local aRetorno := {} 
DEFAULT comprador := ""

SC1 ->(dbGoTop())  

cQuery := " SELECT SC1.C1_NUM,C1_ITEM,C1_CODCOMP,C1_EMISSAO,C1_DT_APRO,C8_EMISSAO,C7_EMISSAO,C1_DTSCSAP,C1_DT_PO,C1_DT_FIM  FROM " +RetSQLName("SC1")+ "  SC1"
cQuery += " Left outer join " +RetSQLName("SC7")+" SC7 on (SC7.D_E_L_E_T_ <> '*' and C1_NUM = C7_NUMSC AND C1_ITEM = C7_ITEMSC)"
cQuery += " Left outer join " +RetSQLName("SC8")+" SC8 on (SC8.D_E_L_E_T_ <> '*' and C1_NUM = C8_NUMSC AND C1_ITEM = C8_ITEMSC)"
cQuery += " Where SC1.D_E_L_E_T_ <> '*' "
cQuery += " AND C1_CODCOMP = '" +comprador+ "'"
                
cQuery += " ORDER BY SC1.C1_NUM "                                                         

TcQuery cQuery New Alias "QRY"

While QRY->(!Eof())
	aAdd (aRetorno,{QRY->C1_NUM,QRY->C1_ITEM,QRY->C1_CODCOMP,QRY->C1_EMISSAO,QRY->C1_DT_APRO,QRY->C8_EMISSAO,QRY->C7_EMISSAO,QRY->C1_DTSCSAP,QRY->C1_DT_PO,QRY->C1_DT_FIM})
	QRY->(dbSkip())
EndDo     

QRY->(dbCloseArea())
                                                                                    
If len(comprador) = 0
	aAdd (aRetorno,{"","","","","","","","","",""})
Endif 

If len(comprador) > 0
	For i:=1 to 5
		aAdd (aRetorno,{"","","","","","","","","",""})
	Next i
Endif 

Return aRetorno  